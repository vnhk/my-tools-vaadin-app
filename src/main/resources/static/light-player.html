<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Player</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #000; color: #fff; font-family: -apple-system, sans-serif; overflow: hidden; height: 100vh; }

        #video-container {
            width: 100vw; height: 100vh;
            display: flex; align-items: center; justify-content: center;
            background: #000;
        }
        video {
            width: 100%; height: 100%;
            object-fit: contain; background: #000;
        }
        video::cue { font-size: 1.4em; background: rgba(0,0,0,0.7); color: #fff; }

        /* Activation overlay */
        #activation-overlay {
            position: fixed; inset: 0; z-index: 1000;
            background: rgba(0,0,0,0.95);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
        }
        #activation-overlay h2 { font-size: 2rem; margin-bottom: 1rem; }
        #activation-overlay .room-id { font-size: 3rem; color: #4CAF50; font-weight: bold; margin: 0.5rem 0; }
        #activation-overlay .hint { color: #888; margin-bottom: 2rem; }
        #activation-overlay button {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: #fff; border: none; padding: 20px 50px;
            font-size: 1.5rem; border-radius: 50px; cursor: pointer;
            box-shadow: 0 4px 15px rgba(76,175,80,0.4);
            transition: transform 0.2s;
        }
        #activation-overlay button:hover { transform: scale(1.05); }

        /* Connection info */
        #connection-info {
            position: fixed; top: 15px; right: 15px; z-index: 900;
            background: rgba(0,0,0,0.8); padding: 10px 15px;
            border-radius: 10px; font-size: 0.85rem;
            display: none; align-items: center; gap: 8px;
        }
        #connection-info .dot {
            width: 8px; height: 8px; border-radius: 50%;
            background: #4CAF50; box-shadow: 0 0 6px #4CAF50;
        }
        #connection-info .close-btn {
            background: none; border: none; color: #fff;
            cursor: pointer; font-size: 1.2rem; margin-left: 8px;
        }

        /* Navigation bar */
        #nav-bar {
            position: fixed; top: 0; left: 0; right: 0; z-index: 800;
            background: rgba(0,0,0,0.7); padding: 8px 15px;
            display: flex; gap: 10px; align-items: center;
            opacity: 0; transition: opacity 0.3s;
        }
        #video-container:hover ~ #nav-bar,
        #nav-bar:hover { opacity: 1; }
        #nav-bar button {
            background: rgba(255,255,255,0.15); border: none;
            color: #fff; padding: 6px 14px; border-radius: 6px;
            cursor: pointer; font-size: 0.85rem;
        }
        #nav-bar button:hover { background: rgba(255,255,255,0.3); }
        #nav-bar .title { flex: 1; font-size: 0.9rem; opacity: 0.8; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* Error */
        #error-msg {
            position: fixed; inset: 0; z-index: 2000;
            background: rgba(0,0,0,0.95);
            display: none; flex-direction: column;
            justify-content: center; align-items: center;
            color: #f44336; font-size: 1.2rem; padding: 20px; text-align: center;
        }

        /* Loading */
        #loading {
            position: fixed; inset: 0; z-index: 500;
            background: #000;
            display: flex; justify-content: center; align-items: center;
            font-size: 1.2rem; color: #888;
        }
    </style>
</head>
<body>
    <div id="loading">Loading...</div>
    <div id="error-msg"></div>

    <div id="video-container">
        <video id="player" playsinline></video>
    </div>

    <div id="nav-bar">
        <button id="btn-prev" style="display:none">Prev</button>
        <span id="video-title" class="title"></span>
        <button id="btn-next" style="display:none">Next</button>
    </div>

    <div id="activation-overlay">
        <h2>Remote Control</h2>
        <div class="room-id" id="room-id-display"></div>
        <div class="hint">Enter this code on your phone to connect</div>
        <button id="btn-activate">Click to Enable Playback</button>
    </div>

    <div id="connection-info">
        <span class="dot"></span>
        <span>Room: <span id="room-id-info"></span></span>
        <button class="close-btn" onclick="this.parentElement.style.display='none'">&times;</button>
    </div>

    <script>
    (function() {
        'use strict';

        // --- State ---
        const params = new URLSearchParams(location.search);
        const productionName = params.get('production');
        const videoFolderId = params.get('video');
        let videoInfo = null;
        let ws = null;
        let hls = null;
        let roomId = localStorage.getItem('roomId');
        if (!roomId || roomId.length > 5) {
            roomId = '' + Math.floor(Math.random() * 90000 + 10000);
            localStorage.setItem('roomId', roomId);
        }

        const video = document.getElementById('player');
        const PROGRESS_INTERVAL = 10000;
        const MIN_TIME_CHANGE = 5.0;
        let lastReportedTime = 0;
        let progressTimer = null;

        // --- Init ---
        if (!productionName || !videoFolderId) {
            showError('Missing URL parameters: ?production=NAME&video=FOLDER_ID');
            return;
        }

        document.getElementById('room-id-display').textContent = roomId;
        document.getElementById('room-id-info').textContent = roomId;

        fetchVideoInfo().then(init).catch(e => showError('Failed to load video: ' + e.message));

        // --- Functions ---

        async function fetchVideoInfo() {
            const resp = await fetch('/api/streaming/light-player/video-info/' +
                encodeURIComponent(productionName) + '/' + encodeURIComponent(videoFolderId));
            if (resp.status === 401) {
                location.href = '/login';
                return;
            }
            if (!resp.ok) throw new Error('HTTP ' + resp.status);
            return resp.json();
        }

        function init(info) {
            videoInfo = info;
            document.getElementById('loading').style.display = 'none';
            document.getElementById('video-title').textContent = info.videoName || '';
            document.title = info.videoName || 'Player';

            // Nav buttons
            if (info.prevEpisodeId) {
                const btn = document.getElementById('btn-prev');
                btn.style.display = '';
                btn.onclick = () => navigateTo(info.prevEpisodeId);
            }
            if (info.nextEpisodeId) {
                const btn = document.getElementById('btn-next');
                btn.style.display = '';
                btn.onclick = () => navigateTo(info.nextEpisodeId);
            }

            // Subtitles
            if (info.subtitleUrls) {
                const langNames = { en: 'English', pl: 'Polish', es: 'Spanish' };
                let first = true;
                for (const [lang, url] of Object.entries(info.subtitleUrls)) {
                    const track = document.createElement('track');
                    track.kind = 'subtitles';
                    track.label = langNames[lang] || lang;
                    track.srclang = lang;
                    track.src = url;
                    if (first) { track.default = true; first = false; }
                    video.appendChild(track);
                }
            }

            // Activation overlay
            document.getElementById('btn-activate').onclick = activatePlayback;

            // Setup video source
            if (info.videoFormat === 'HLS') {
                loadHls(info.videoUrl, info.watchProgress);
            } else {
                video.src = info.videoUrl;
                if (info.watchProgress > 0) {
                    video.addEventListener('loadedmetadata', () => { video.currentTime = info.watchProgress; }, { once: true });
                }
            }

            // WebSocket
            connectWebSocket();

            // Keyboard
            setupKeyboard();
        }

        function activatePlayback() {
            video.muted = true;
            video.play().then(() => {
                video.pause();
                video.muted = false;
                if (videoInfo.watchProgress > 0) video.currentTime = videoInfo.watchProgress;
            }).catch(() => {});

            document.getElementById('activation-overlay').style.display = 'none';
            const ci = document.getElementById('connection-info');
            ci.style.display = 'flex';
            setTimeout(() => { ci.style.display = 'none'; }, 10000);

            startProgressTracking();
        }

        function loadHls(url, startTime) {
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/hls.js@latest';
            script.onload = () => {
                if (!Hls.isSupported()) {
                    // Safari native HLS
                    video.src = url;
                    if (startTime > 0) {
                        video.addEventListener('loadedmetadata', () => { video.currentTime = startTime; }, { once: true });
                    }
                    return;
                }
                hls = new Hls({ enableWorker: true, lowLatencyMode: false });
                hls.loadSource(url);
                hls.attachMedia(video);
                hls.on(Hls.Events.MANIFEST_PARSED, () => {
                    if (startTime > 0) video.currentTime = startTime;
                });
            };
            document.head.appendChild(script);
        }

        function navigateTo(episodeId) {
            location.href = '/api/streaming/light-player/page?production=' +
                encodeURIComponent(productionName) + '&video=' + encodeURIComponent(episodeId);
        }

        // --- Watch Progress ---

        function startProgressTracking() {
            if (progressTimer) clearInterval(progressTimer);
            progressTimer = setInterval(() => {
                if (!isNaN(video.currentTime) && Math.abs(video.currentTime - lastReportedTime) >= MIN_TIME_CHANGE) {
                    lastReportedTime = video.currentTime;
                    fetch('/api/streaming/light-player/watch-progress', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ videoId: videoFolderId, currentTime: video.currentTime })
                    }).catch(() => {});
                }
            }, PROGRESS_INTERVAL);
        }

        // --- WebSocket Remote Control ---

        function connectWebSocket() {
            const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = proto + '//' + location.host + '/ws/remote-control?deviceType=TV&roomId=' + roomId;
            ws = new WebSocket(wsUrl);

            ws.onmessage = (event) => {
                try {
                    handleCommand(JSON.parse(event.data));
                } catch(e) { console.error('WS parse error', e); }
            };

            ws.onclose = () => { setTimeout(connectWebSocket, 3000); };
        }

        function sendToRemote(msg) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(msg));
            }
        }

        function handleCommand(msg) {
            switch (msg.action) {
                case 'PLAY':
                    video.play(); break;
                case 'PAUSE':
                    video.pause(); break;
                case 'TOGGLE_PLAY':
                    video.paused ? video.play() : video.pause(); break;
                case 'SEEK':
                    if (msg.data && msg.data.relative != null) video.currentTime += msg.data.relative;
                    break;
                case 'VOLUME':
                    if (msg.data && msg.data.relative != null)
                        video.volume = Math.max(0, Math.min(1, video.volume + msg.data.relative));
                    break;
                case 'MAXIMIZE':
                    toggleMaximize(); break;
                case 'PIP':
                    togglePiP(); break;
                case 'FULLSCREEN_PROMPT':
                case 'FULLSCREEN':
                    toggleFullscreen(); break;
                case 'NAVIGATE':
                    if (msg.data && msg.data.url) location.href = msg.data.url;
                    break;
                case 'GET_TRACKS':
                    sendTracks(msg.data ? msg.data.trackType : null); break;
                case 'SET_AUDIO_TRACK':
                    setAudioTrack(msg.data ? msg.data.index : 0); break;
                case 'SET_SUBTITLE_TRACK':
                    setSubtitleTrack(msg.data ? msg.data.index : -1); break;
                case 'NEXT_EPISODE':
                    if (videoInfo && videoInfo.nextEpisodeId) navigateTo(videoInfo.nextEpisodeId);
                    break;
                case 'PREV_EPISODE':
                    if (videoInfo && videoInfo.prevEpisodeId) navigateTo(videoInfo.prevEpisodeId);
                    break;
            }
        }

        function sendTracks(trackType) {
            if (trackType === 'audio') {
                const tracks = [];
                if (hls) {
                    hls.audioTracks.forEach((t, i) => {
                        tracks.push({ index: i, name: t.name || ('Audio ' + (i+1)), lang: t.lang || 'und' });
                    });
                    sendToRemote({ type: 'TRACKS_RESPONSE', trackType: 'audio', tracks: tracks, currentIndex: hls.audioTrack });
                } else {
                    sendToRemote({ type: 'TRACKS_RESPONSE', trackType: 'audio', tracks: [], currentIndex: 0 });
                }
            } else if (trackType === 'subtitles') {
                const tracks = [{ index: -1, name: 'Off', lang: 'off' }];
                let currentIndex = -1;
                if (hls && hls.subtitleTracks.length > 0) {
                    hls.subtitleTracks.forEach((t, i) => {
                        tracks.push({ index: i, name: t.name || ('Subtitle ' + (i+1)), lang: t.lang || 'und' });
                    });
                    currentIndex = hls.subtitleTrack;
                } else {
                    for (let i = 0; i < video.textTracks.length; i++) {
                        const t = video.textTracks[i];
                        if (t.kind === 'subtitles' || t.kind === 'captions') {
                            tracks.push({ index: 1000 + i, name: t.label || ('Subtitle ' + (i+1)), lang: t.language || 'und' });
                            if (t.mode === 'showing') currentIndex = 1000 + i;
                        }
                    }
                }
                sendToRemote({ type: 'TRACKS_RESPONSE', trackType: 'subtitles', tracks: tracks, currentIndex: currentIndex });
            }
        }

        function setAudioTrack(index) {
            if (hls) hls.audioTrack = index;
        }

        function setSubtitleTrack(index) {
            if (index === -1) {
                if (hls) hls.subtitleTrack = -1;
                for (let i = 0; i < video.textTracks.length; i++) video.textTracks[i].mode = 'hidden';
            } else if (index >= 1000) {
                if (hls) hls.subtitleTrack = -1;
                const ni = index - 1000;
                for (let i = 0; i < video.textTracks.length; i++)
                    video.textTracks[i].mode = (i === ni) ? 'showing' : 'hidden';
            } else {
                if (hls) hls.subtitleTrack = index;
            }
        }

        function toggleFullscreen() {
            if (document.fullscreenElement) {
                document.exitFullscreen();
            } else {
                (video.requestFullscreen || video.webkitRequestFullscreen || function(){}).call(video);
            }
        }

        function togglePiP() {
            if (document.pictureInPictureElement) {
                document.exitPictureInPicture();
            } else if (document.pictureInPictureEnabled) {
                video.requestPictureInPicture().catch(() => {});
            }
        }

        function toggleMaximize() {
            // Already fullscreen by default in this light player
            toggleFullscreen();
        }

        // --- Keyboard ---

        function setupKeyboard() {
            document.addEventListener('keydown', (e) => {
                switch (e.code) {
                    case 'Space':
                        e.preventDefault();
                        video.paused ? video.play() : video.pause();
                        break;
                    case 'ArrowLeft':
                        e.preventDefault(); video.currentTime -= 5; break;
                    case 'ArrowRight':
                        e.preventDefault(); video.currentTime += 5; break;
                    case 'ArrowUp':
                        e.preventDefault();
                        video.volume = Math.min(1, video.volume + 0.1); break;
                    case 'ArrowDown':
                        e.preventDefault();
                        video.volume = Math.max(0, video.volume - 0.1); break;
                    case 'KeyF':
                        e.preventDefault(); toggleFullscreen(); break;
                    case 'KeyB':
                        e.preventDefault(); toggleSubtitles(); break;
                }
            });
        }

        function toggleSubtitles() {
            for (let i = 0; i < video.textTracks.length; i++) {
                const t = video.textTracks[i];
                if (t.kind === 'subtitles' || t.kind === 'captions') {
                    t.mode = t.mode === 'showing' ? 'hidden' : 'showing';
                }
            }
        }

        // --- Media Session API ---
        if ('mediaSession' in navigator) {
            navigator.mediaSession.setActionHandler('play', () => video.play());
            navigator.mediaSession.setActionHandler('pause', () => video.pause());
            navigator.mediaSession.setActionHandler('seekbackward', () => { video.currentTime -= 10; });
            navigator.mediaSession.setActionHandler('seekforward', () => { video.currentTime += 10; });
        }

        // --- Helpers ---

        function showError(msg) {
            document.getElementById('loading').style.display = 'none';
            const el = document.getElementById('error-msg');
            el.textContent = msg;
            el.style.display = 'flex';
        }
    })();
    </script>
</body>
</html>
